<!DOCTYPE html>
<html lang="en">
<head>
        <meta charset="utf-8" />
        <title>My Blog/Notes - Linux</title>
        <link rel="stylesheet" href="/theme/css/main.css" />

        <!--[if IE]>
            <script src="https://html5shiv.googlecode.com/svn/trunk/html5.js"></script>
        <![endif]-->
</head>

<body id="index" class="home">
        <header id="banner" class="body">
                <h1><a href="/">My Blog/Notes </a></h1>
                <nav><ul>
                    <li class="active"><a href="/category/linux.html">Linux</a></li>
                    <li><a href="/category/python.html">python</a></li>
                    <li><a href="/category/raspberry-pi.html">Raspberry Pi</a></li>
                </ul></nav>
        </header><!-- /#banner -->

            <aside id="featured" class="body">
                <article>
                    <h1 class="entry-title"><a href="/iptables-example.html">Basic IPTables Tutorial</a></h1>
<footer class="post-info">
        <abbr class="published" title="2018-01-20T00:00:00+01:00">
                Published: Sat 20 January 2018
        </abbr>
		<br />
        <abbr class="modified" title="2018-01-20T00:00:00+01:00">
                Updated: Sat 20 January 2018
        </abbr>

        <address class="vcard author">
                By                         <a class="url fn" href="/author/masoko.html">Masoko</a>
        </address>
<p>In <a href="/category/linux.html">Linux</a>.</p>

</footer><!-- /.post-info --><p>This is the iptables configuration I have used to secure my pihole instance before exposing it publicly.  </p>
<p>First we need to create a file that will hold our iptables rules.<br>
I have choosen to name this file iptables.up.rules and create it in /etc folder. You can pick any name and location you like, just remember to use them in the auto start bash script we'll create at the end of this tutorial.</p>
<p>The content of my iptables.up.rules file is:</p>
<div class="highlight"><pre><span></span># Generated by iptables-save v1.6.0 on Thu Dec 28 12:35:47 2017
*filter
:INPUT ACCEPT [3153:549434]
:FORWARD ACCEPT [0:0]
:OUTPUT ACCEPT [2890:317837]

# Don&#39;t forward traffic
-P FORWARD DROP

# Allow outgoing traffic
-P OUTPUT ACCEPT

# Allow established traffic
-A INPUT -m state --state ESTABLISHED,RELATED -j ACCEPT

# Allow localhost traffic
-A INPUT -i lo -j ACCEPT

#############################
#  MANAGEMENT RULES
#############################
# Allow SSH (alternate port)
-A INPUT -p tcp --dport 22 -j ACCEPT

#############################
#  ACCESS RULES
#############################
# Allow web server
-A INPUT -p udp --dport 80 -j ACCEPT 
-A OUTPUT -p udp --sport 80 -j ACCEPT
-A INPUT -p tcp --dport 80 -j ACCEPT 
-A OUTPUT -p tcp --sport 80 -j ACCEPT

-A INPUT -p tcp --dport 443 -j ACCEPT 
-A OUTPUT -p tcp --sport 443 -j ACCEPT
-A INPUT -p udp --dport 443 -j ACCEPT 
-A OUTPUT -p udp --sport 443 -j ACCEPT

-A INPUT -p icmp --icmp-type 8 -s 0/0 -d 192.168.0.103 -m state --state NEW,ESTABLISHED,RELATED -j ACCEPT
-A OUTPUT -p icmp --icmp-type 0 -s 192.168.0.103 -d 0/0 -m state --state ESTABLISHED,RELATED -j ACCEPT

# Allow DNS

# home.masoko.net 46.249.76.212

-A OUTPUT -p udp -o eth0 -d 46.249.76.212 --sport 53 -j ACCEPT
-A OUTPUT -p udp -o eth0 -d 46.249.76.212 --dport 53 -j ACCEPT
-A INPUT -p udp -i eth0 -s 46.249.76.212 --sport 53 -j ACCEPT
-A INPUT -p udp -i eth0 -s 46.249.76.212 --dport 53 -j ACCEPT

# home - this section allows access to and from your internal network
-A OUTPUT -p udp -o eth0 -m iprange --dst-range 192.168.0.1-192.168.0.254 --sport 53 -j ACCEPT
-A OUTPUT -p udp -o eth0 -m iprange --dst-range 192.168.0.1-192.168.0.254 --dport 53 -j ACCEPT
-A INPUT -p udp -i eth0 -m iprange --src-range 192.168.0.1-192.168.0.254 --sport 53 -j ACCEPT
-A INPUT -p udp -i eth0 -m iprange --src-range 192.168.0.1-192.168.0.254 --dport 53 -j ACCEPT

# Allow NTP Assuming you are a CLIENT and want to access NTP servers you&#39;d do:
-A OUTPUT -p udp --dport 123 -j ACCEPT 
-A INPUT -p udp --sport 123 -j ACCEPT

# Assuming you want to be a server, you&#39;d do
-A INPUT -p udp --dport 123 -j ACCEPT 
-A OUTPUT -p udp --sport 123 -j ACCEPT

#############################
#  DEFAULT DENY
#############################
-A INPUT -j DROP
COMMIT
</pre></div>


<p>Run this command to check if the new rules are working as expected:  </p>
<div class="highlight"><pre><span></span>sudo /sbin/iptables-restore &lt; /etc/iptables.up.rules
</pre></div>


<p>If there are no errors and you are not disconnected from the system we sould be all set.    </p>
<p>Now we need to make sure the iptables rules are loaded after the system is restarted.</p>
<p>To do so go to /etc/network/if-pre-up.d and create a file named iptables, this is a bash file that will be executed before each network connection,
the content of this file shuuold be as below:</p>
<pre><code>#!/bin/sh
sudo /sbin/iptables-restore < /etc/iptables.up.rules
</code></pre>

<p>You'll also need to make sure that the file iptables have executable permissions:</p>
<div class="highlight"><pre><span></span>sudo chmod +x iptables
</pre></div>


<p>Everything should be configured now, restart your system to make sure the rules are loaded properly.</p>                </article>
            </aside><!-- /#featured -->
        <section id="extras" class="body">
                <div class="blogroll">
                        <h2>links</h2>
                        <ul>
                            <li><a href="http://getpelican.com/">Pelican</a></li>
                            <li><a href="http://python.org/">Python.org</a></li>
                            <li><a href="http://jinja.pocoo.org/">Jinja2</a></li>
                        </ul>
                </div><!-- /.blogroll -->
                <div class="social">
                        <h2>social</h2>
                        <ul>

                            <li><a href="#">You can add links in your config file</a></li>
                            <li><a href="#">Another social link</a></li>
                        </ul>
                </div><!-- /.social -->
        </section><!-- /#extras -->

        <footer id="contentinfo" class="body">
                <address id="about" class="vcard body">
                Proudly powered by <a href="http://getpelican.com/">Pelican</a>, which takes great advantage of <a href="http://python.org">Python</a>.
                </address><!-- /#about -->

                <p>The theme is by <a href="http://coding.smashingmagazine.com/2009/08/04/designing-a-html-5-layout-from-scratch/">Smashing Magazine</a>, thanks!</p>
        </footer><!-- /#contentinfo -->

</body>
</html>